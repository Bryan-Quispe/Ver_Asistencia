<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistencia ESPE - Per√≠odo Actual</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #16213e;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid #2d3561;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    h1 {
      color: #4dd0e1;
      font-size: 28px;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-badge {
      background: rgba(76, 208, 225, 0.2);
      color: #4dd0e1;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #4dd0e1;
    }

    .tiempo-actualizacion {
      background: rgba(255, 152, 0, 0.2);
      color: #ffb74d;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #ff9800;
    }

    .tabla-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #0f1f35;
      border: 1px solid #2d3561;
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(135deg, #152a45 0%, #1a3555 100%);
      border-bottom: 2px solid #4dd0e1;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 18px 15px;
      text-align: left;
      color: #4dd0e1;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #2d3561;
      color: #e0e0e0;
      font-size: 14px;
    }

    tbody tr {
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: rgba(77, 208, 225, 0.1);
    }

    .asistencia-alta {
      color: #81c784;
      font-weight: 600;
    }

    .asistencia-media {
      color: #ffb74d;
      font-weight: 600;
    }

    .asistencia-baja {
      color: #ff7070;
      font-weight: 600;
    }

    .btn-monitorear {
      background: #4dd0e1;
      color: #0f1f35;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      max-width: 130px;
    }

    .btn-monitorear:hover {
      background: #26c6da;
      transform: scale(1.05);
    }

    .btn-monitorear:active {
      transform: scale(0.95);
    }

    .btn-monitorear.agregado {
      background: #81c784;
      cursor: default;
    }

    .btn-monitorear.agregado:hover {
      transform: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #4dd0e1;
      font-size: 18px;
    }

    .error {
      background: rgba(244, 67, 54, 0.2);
      color: #ff7070;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #0d1a3a 0%, #1a2d4a 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #2d3561;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #4dd0e1;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #90a4ae;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .controles {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button.btn-principal {
      background: linear-gradient(135deg, #4dd0e1 0%, #26c6da 100%);
      color: #0f1f35;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: auto;
    }

    button.btn-principal:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(77, 208, 225, 0.3);
    }

    button.btn-principal:active {
      transform: translateY(0);
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 22px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-info {
        width: 100%;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 10px 8px;
      }

      .btn-monitorear {
        max-width: 100%;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .controles {
        flex-direction: column;
      }

      button.btn-principal {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö Asistencia ESPE - Per√≠odo Actual</h1>
      <div class="header-info">
        <div class="status-badge">‚úÖ Actualizaci√≥n cada hora</div>
        <div class="tiempo-actualizacion" id="tiempo-proxima">Pr√≥xima: --:--</div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-cursos">0</div>
        <div class="stat-label">Total de Cursos</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cursos-buenos" style="color: #81c784;">0</div>
        <div class="stat-label">Buena Asistencia (‚â•85%)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cursos-riesgo" style="color: #ffb74d;">0</div>
        <div class="stat-label">En Riesgo (70-85%)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cursos-criticos" style="color: #ff7070;">0</div>
        <div class="stat-label">Cr√≠tico (<70%)</div>
      </div>
    </div>

    <div class="controles">
      <div style="display: flex; gap: 10px; width: 100%; flex-wrap: wrap;">
        <input type="text" id="nrc-input" placeholder="Ingresa NRC..." style="flex: 1; min-width: 150px; padding: 12px; border-radius: 8px; border: 1px solid #2d3561; background: #0f1f35; color: #e0e0e0; font-size: 14px;">
        <button class="btn-principal" onclick="agregarCurso()">‚ûï Agregar</button>
      </div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap; width: 100%;">
        <button class="btn-principal" onclick="actualizarAhora()" style="flex: 1;">üîÑ Actualizar Ahora</button>
        <button class="btn-principal" onclick="limpiarTodos()" style="flex: 1;">üóëÔ∏è Limpiar Todo</button>
      </div>
    </div>

    <div class="tabla-container">
      <div id="contenido"></div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://cooperative-tierney-losmascapitos-480b8f15.koyeb.app';
    const INTERVALO_ACTUALIZACION = 60 * 60 * 1000; // 1 hora
    const LIMITE_ASISTENCIA = 85;

    let cursosAgregados = [];

    // ==================== INICIALIZACI√ìN ====================
    document.addEventListener('DOMContentLoaded', () => {
      cargarCursosGuardados();
      mostrarTabla();
      iniciarActualizacionAutomatica();
      
      // Enter key en el input
      document.getElementById('nrc-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') agregarCurso();
      });
    });

    // ==================== CARGAR CURSOS GUARDADOS ====================
    function cargarCursosGuardados() {
      const guardados = localStorage.getItem('cursosAgregados');
      if (guardados) {
        cursosAgregados = JSON.parse(guardados);
      }
    }

    function guardarCursos() {
      localStorage.setItem('cursosAgregados', JSON.stringify(cursosAgregados));
    }

    // ==================== AGREGAR CURSO ====================
    async function agregarCurso() {
      const input = document.getElementById('nrc-input');
      const nrc = input.value.trim().toUpperCase();

      if (!nrc) {
        alert('‚ö†Ô∏è Ingresa un NRC');
        return;
      }

      if (cursosAgregados.some(c => c.nrc === nrc)) {
        alert('‚ùå Este NRC ya est√° agregado');
        input.value = '';
        return;
      }

      const contenido = document.getElementById('contenido');
      contenido.innerHTML = '<div class="loading">üîç Buscando curso...</div>';

      try {
        const response = await fetch(`${BACKEND_URL}/api/consultar-curso`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nrc })
        });

        const data = await response.json();

        if (!data.success || data.totalCount === 0) {
          alert('‚ùå No se encontr√≥ ese NRC');
          mostrarTabla();
          return;
        }

        const curso = data.data[0];
        cursosAgregados.push({
          nrc: nrc,
          codigo: curso.subjectCode,
          nombre: curso.subjectDesc,
          ultima_actualizacion: new Date().toISOString()
        });

        guardarCursos();
        input.value = '';
        alert('‚úÖ Curso agregado');
        actualizarTodosCursos();
      } catch (error) {
        alert(`‚ùå Error: ${error.message}`);
        mostrarTabla();
      }
    }

    // ==================== ACTUALIZAR TODOS LOS CURSOS ====================
    async function actualizarTodosCursos() {
      if (cursosAgregados.length === 0) {
        mostrarTabla();
        return;
      }

      const contenido = document.getElementById('contenido');
      contenido.innerHTML = '<div class="loading">üì° Actualizando cursos...</div>';

      const cursosActualizados = [];
      let errores = 0;

      for (const curso of cursosAgregados) {
        try {
          const response = await fetch(`${BACKEND_URL}/api/consultar-curso`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nrc: curso.nrc })
          });

          const data = await response.json();

          if (data.success && data.totalCount > 0) {
            const datoCurso = data.data[0];
            cursosActualizados.push({
              ...curso,
              percentage: datoCurso.percentage,
              missed: datoCurso.missed,
              ultima_actualizacion: new Date().toISOString()
            });
          } else {
            errores++;
            cursosActualizados.push({
              ...curso,
              percentage: 0,
              missed: 0,
              error: true
            });
          }
        } catch (error) {
          errores++;
          cursosActualizados.push({
            ...curso,
            percentage: 0,
            missed: 0,
            error: true
          });
        }
      }

      cursosAgregados = cursosActualizados;
      guardarCursos();
      generarTabla();

      if (errores > 0) {
        console.warn(`‚ö†Ô∏è ${errores} cursos no actualizados`);
      }
    }

    function mostrarTabla() {
      if (cursosAgregados.length === 0) {
        document.getElementById('contenido').innerHTML = '<div class="loading">üëâ Agrega un NRC para comenzar</div>';
        actualizarEstadisticas([]);
        return;
      }
      generarTabla();
    }

    function generarTabla() {
      const contenido = document.getElementById('contenido');

      let html = `
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre de la Materia</th>
              <th>NRC</th>
              <th style="text-align: center;">Asistencia</th>
              <th style="text-align: center;">Faltas</th>
              <th style="text-align: center;">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
      `;

      cursosAgregados.forEach((curso) => {
        if (curso.error) {
          html += `
            <tr style="opacity: 0.6;">
              <td><strong>${curso.codigo}</strong></td>
              <td>${curso.nombre}</td>
              <td><strong>${curso.nrc}</strong></td>
              <td colspan="2" style="text-align: center; color: #ff7070;">‚ùå Error al actualizar</td>
              <td style="text-align: center;">
                <button class="btn-monitorear" onclick="eliminarCurso('${curso.nrc}')" style="background: #ff7070;">üóëÔ∏è Eliminar</button>
              </td>
            </tr>
          `;
          return;
        }

        const claseAsistencia = curso.percentage >= LIMITE_ASISTENCIA ? 'asistencia-alta' : 
                               curso.percentage >= 70 ? 'asistencia-media' : 'asistencia-baja';
        
        const icon = curso.percentage >= LIMITE_ASISTENCIA ? '‚úÖ' : curso.percentage >= 70 ? '‚ö†Ô∏è' : 'üö®';

        html += `
          <tr>
            <td><strong>${curso.codigo}</strong></td>
            <td>${curso.nombre}</td>
            <td><strong>${curso.nrc}</strong></td>
            <td style="text-align: center;"><span class="${claseAsistencia}">${icon} ${curso.percentage}%</span></td>
            <td style="text-align: center;">${curso.missed}</td>
            <td style="text-align: center;">
              <button class="btn-monitorear" onclick="eliminarCurso('${curso.nrc}')" style="background: #ff7070;">üóëÔ∏è Eliminar</button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      contenido.innerHTML = html;
      actualizarEstadisticas(cursosAgregados);
    }

    // ==================== ELIMINAR CURSO ====================
    function eliminarCurso(nrc) {
      if (confirm(`¬øEliminar este curso?`)) {
        cursosAgregados = cursosAgregados.filter(c => c.nrc !== nrc);
        guardarCursos();
        alert('‚úÖ Curso eliminado');
        mostrarTabla();
      }
    }

    function limpiarTodos() {
      if (confirm('¬øEliminar TODOS los cursos?')) {
        cursosAgregados = [];
        guardarCursos();
        alert('‚úÖ Todo limpiado');
        mostrarTabla();
      }
    }

    // ==================== ESTAD√çSTICAS ====================
    function actualizarEstadisticas(cursos) {
      const total = cursos.length;
      const buenos = cursos.filter(c => !c.error && c.percentage >= LIMITE_ASISTENCIA).length;
      const riesgo = cursos.filter(c => !c.error && c.percentage >= 70 && c.percentage < LIMITE_ASISTENCIA).length;
      const criticos = cursos.filter(c => !c.error && c.percentage < 70).length;

      document.getElementById('total-cursos').textContent = total;
      document.getElementById('cursos-buenos').textContent = buenos;
      document.getElementById('cursos-riesgo').textContent = riesgo;
      document.getElementById('cursos-criticos').textContent = criticos;
    }

    // ==================== ACTUALIZACI√ìN AUTOM√ÅTICA ====================
    function iniciarActualizacionAutomatica() {
      // Actualizar cada hora
      setInterval(() => {
        console.log('üîÑ Actualizando cursos autom√°ticamente...');
        actualizarTodosCursos();
      }, INTERVALO_ACTUALIZACION);

      actualizarTiempoProximo();
      setInterval(actualizarTiempoProximo, 60000); // Actualizar cada minuto
    }

    function actualizarTiempoProximo() {
      const ahora = new Date();
      const proximaHora = new Date(ahora);
      proximaHora.setHours(proximaHora.getHours() + 1);
      proximaHora.setMinutes(0);
      proximaHora.setSeconds(0);

      const horas = String(proximaHora.getHours()).padStart(2, '0');
      const minutos = String(proximaHora.getMinutes()).padStart(2, '0');

      document.getElementById('tiempo-proxima').textContent = `Pr√≥xima: ${horas}:${minutos}`;
    }

    async function actualizarAhora() {
      await actualizarTodosCursos();
    }
  </script>
</body>
</html>
