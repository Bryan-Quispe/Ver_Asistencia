<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asistencia ESPE - Per√≠odo Actual</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0f0f1e 0%, #1a1a2e 100%);
      min-height: 100vh;
      padding: 20px;
      color: #e0e0e0;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: #16213e;
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 1px solid #2d3561;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      flex-wrap: wrap;
      gap: 20px;
    }

    h1 {
      color: #4dd0e1;
      font-size: 28px;
    }

    .header-info {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }

    .status-badge {
      background: rgba(76, 208, 225, 0.2);
      color: #4dd0e1;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #4dd0e1;
    }

    .tiempo-actualizacion {
      background: rgba(255, 152, 0, 0.2);
      color: #ffb74d;
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid #ff9800;
    }

    .tabla-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #0f1f35;
      border: 1px solid #2d3561;
      border-radius: 8px;
      overflow: hidden;
    }

    thead {
      background: linear-gradient(135deg, #152a45 0%, #1a3555 100%);
      border-bottom: 2px solid #4dd0e1;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 18px 15px;
      text-align: left;
      color: #4dd0e1;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 15px;
      border-bottom: 1px solid #2d3561;
      color: #e0e0e0;
      font-size: 14px;
    }

    tbody tr {
      transition: all 0.2s;
    }

    tbody tr:hover {
      background: rgba(77, 208, 225, 0.1);
    }

    .asistencia-alta {
      color: #81c784;
      font-weight: 600;
    }

    .asistencia-media {
      color: #ffb74d;
      font-weight: 600;
    }

    .asistencia-baja {
      color: #ff7070;
      font-weight: 600;
    }

    .btn-monitorear {
      background: #4dd0e1;
      color: #0f1f35;
      padding: 8px 14px;
      font-size: 12px;
      font-weight: 600;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      max-width: 130px;
    }

    .btn-monitorear:hover {
      background: #26c6da;
      transform: scale(1.05);
    }

    .btn-monitorear:active {
      transform: scale(0.95);
    }

    .btn-monitorear.agregado {
      background: #81c784;
      cursor: default;
    }

    .btn-monitorear.agregado:hover {
      transform: none;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #4dd0e1;
      font-size: 18px;
    }

    .error {
      background: rgba(244, 67, 54, 0.2);
      color: #ff7070;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #f44336;
      text-align: center;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, #0d1a3a 0%, #1a2d4a 100%);
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #2d3561;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #4dd0e1;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #90a4ae;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .controles {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button.btn-principal {
      background: linear-gradient(135deg, #4dd0e1 0%, #26c6da 100%);
      color: #0f1f35;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      width: auto;
    }

    button.btn-principal:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(77, 208, 225, 0.3);
    }

    button.btn-principal:active {
      transform: translateY(0);
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
      }

      h1 {
        font-size: 22px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-info {
        width: 100%;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 10px 8px;
      }

      .btn-monitorear {
        max-width: 100%;
      }

      .stats {
        grid-template-columns: 1fr;
      }

      .controles {
        flex-direction: column;
      }

      button.btn-principal {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìö Asistencia ESPE - Per√≠odo Actual</h1>
      <div class="header-info">
        <div class="status-badge">‚úÖ Actualizaci√≥n cada hora</div>
        <div class="tiempo-actualizacion" id="tiempo-proxima">Pr√≥xima: --:--</div>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="total-cursos">0</div>
        <div class="stat-label">Total de Cursos</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cursos-buenos" style="color: #81c784;">0</div>
        <div class="stat-label">Buena Asistencia (‚â•85%)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cursos-riesgo" style="color: #ffb74d;">0</div>
        <div class="stat-label">En Riesgo (70-85%)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="cursos-criticos" style="color: #ff7070;">0</div>
        <div class="stat-label">Cr√≠tico (<70%)</div>
      </div>
    </div>

    <div class="controles">
      <button class="btn-principal" onclick="cargarTabla()">üîÑ Actualizar Ahora</button>
      <button class="btn-principal" onclick="mostrarMonitoreadas()">üëÅÔ∏è Ver Monitoreadas</button>
      <button class="btn-principal" onclick="limpiarMonitor()">üóëÔ∏è Limpiar Monitor</button>
    </div>

    <div class="tabla-container">
      <div id="contenido"></div>
    </div>
  </div>

  <script>
    const BACKEND_URL = 'https://cooperative-tierney-losmascapitos-480b8f15.koyeb.app';
    const INTERVALO_ACTUALIZACION = 60 * 60 * 1000; // 1 hora
    const LIMITE_ASISTENCIA = 85;

    let todosCursos = [];

    // ==================== INICIALIZACI√ìN ====================
    document.addEventListener('DOMContentLoaded', () => {
      cargarTabla();
      iniciarActualizacionAutomatica();
    });

    // ==================== CARGAR TABLA ====================
    async function cargarTabla() {
      const contenido = document.getElementById('contenido');
      contenido.innerHTML = '<div class="loading">üì° Cargando todos tus cursos...</div>';

      try {
        const response = await fetch(`${BACKEND_URL}/api/todos-cursos`);
        const data = await response.json();

        if (!data.success || data.totalCount === 0) {
          contenido.innerHTML = '<div class="error">‚ùå No se encontraron cursos registrados</div>';
          return;
        }

        todosCursos = data.data;
        generarTabla(todosCursos);
        actualizarEstadisticas();
      } catch (error) {
        contenido.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
      }
    }

    function generarTabla(cursos) {
      const contenido = document.getElementById('contenido');
      const monitoreadas = JSON.parse(localStorage.getItem('materiasMonitoreadas') || '[]');

      let html = `
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Nombre de la Materia</th>
              <th>NRC</th>
              <th style="text-align: center;">Asistencia</th>
              <th style="text-align: center;">Faltas</th>
              <th style="text-align: center;">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
      `;

      cursos.forEach(curso => {
        const claseAsistencia = curso.percentage >= LIMITE_ASISTENCIA ? 'asistencia-alta' : 
                               curso.percentage >= 70 ? 'asistencia-media' : 'asistencia-baja';
        
        const icon = curso.percentage >= LIMITE_ASISTENCIA ? '‚úÖ' : curso.percentage >= 70 ? '‚ö†Ô∏è' : 'üö®';
        
        const nrc = curso.courseReferenceNumber;
        const estaMonitoreada = monitoreadas.includes(nrc);
        const btnClass = estaMonitoreada ? 'agregado' : '';
        const btnTexto = estaMonitoreada ? '‚úì Monitoreada' : '‚ûï Monitorear';
        const btnDisabled = estaMonitoreada ? 'disabled' : '';

        html += `
          <tr>
            <td><strong>${curso.subjectCode}</strong></td>
            <td>${curso.subjectDesc}</td>
            <td><strong>${nrc}</strong></td>
            <td style="text-align: center;"><span class="${claseAsistencia}">${icon} ${curso.percentage}%</span></td>
            <td style="text-align: center;">${curso.missed}</td>
            <td style="text-align: center;">
              <button class="btn-monitorear ${btnClass}" onclick="agregarAlMonitor('${nrc}')" ${btnDisabled}>${btnTexto}</button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      contenido.innerHTML = html;
    }

    // ==================== MONITOREO ====================
    function agregarAlMonitor(nrc) {
      let monitoreadas = JSON.parse(localStorage.getItem('materiasMonitoreadas') || '[]');
      
      if (monitoreadas.includes(nrc)) {
        alert('Esta materia ya est√° siendo monitoreada');
        return;
      }

      monitoreadas.push(nrc);
      localStorage.setItem('materiasMonitoreadas', JSON.stringify(monitoreadas));
      
      // Guardar datos de la materia
      const curso = todosCursos.find(c => c.courseReferenceNumber === nrc);
      if (curso) {
        localStorage.setItem(`materia_${nrc}`, JSON.stringify({
          seccion: curso,
          fecha: new Date().toISOString()
        }));
      }

      alert('‚úÖ Materia agregada al monitor');
      generarTabla(todosCursos);
    }

    function mostrarMonitoreadas() {
      const monitoreadas = JSON.parse(localStorage.getItem('materiasMonitoreadas') || '[]');
      
      if (monitoreadas.length === 0) {
        alert('‚ùå No tienes materias monitoreadas a√∫n');
        return;
      }

      const filtrados = todosCursos.filter(c => monitoreadas.includes(c.courseReferenceNumber));
      generarTabla(filtrados);
    }

    function limpiarMonitor() {
      if (confirm('¬øEliminar TODAS las materias monitoreadas?')) {
        const monitoreadas = JSON.parse(localStorage.getItem('materiasMonitoreadas') || '[]');
        monitoreadas.forEach(nrc => localStorage.removeItem(`materia_${nrc}`));
        localStorage.removeItem('materiasMonitoreadas');
        alert('‚úÖ Monitor limpiado');
        generarTabla(todosCursos);
      }
    }

    // ==================== ESTAD√çSTICAS ====================
    function actualizarEstadisticas() {
      const total = todosCursos.length;
      const buenos = todosCursos.filter(c => c.percentage >= LIMITE_ASISTENCIA).length;
      const riesgo = todosCursos.filter(c => c.percentage >= 70 && c.percentage < LIMITE_ASISTENCIA).length;
      const criticos = todosCursos.filter(c => c.percentage < 70).length;

      document.getElementById('total-cursos').textContent = total;
      document.getElementById('cursos-buenos').textContent = buenos;
      document.getElementById('cursos-riesgo').textContent = riesgo;
      document.getElementById('cursos-criticos').textContent = criticos;
    }

    // ==================== ACTUALIZACI√ìN AUTOM√ÅTICA ====================
    function iniciarActualizacionAutomatica() {
      // Cargar cada hora
      setInterval(() => {
        console.log('üîÑ Actualizando tabla autom√°ticamente...');
        cargarTabla();
      }, INTERVALO_ACTUALIZACION);

      actualizarTiempoProximo();
      setInterval(actualizarTiempoProximo, 60000); // Actualizar cada minuto
    }

    function actualizarTiempoProximo() {
      const ahora = new Date();
      const proximaHora = new Date(ahora);
      proximaHora.setHours(proximaHora.getHours() + 1);
      proximaHora.setMinutes(0);
      proximaHora.setSeconds(0);

      const horas = String(proximaHora.getHours()).padStart(2, '0');
      const minutos = String(proximaHora.getMinutes()).padStart(2, '0');

      document.getElementById('tiempo-proxima').textContent = `Pr√≥xima: ${horas}:${minutos}`;
    }
  </script>
</body>
</html>
